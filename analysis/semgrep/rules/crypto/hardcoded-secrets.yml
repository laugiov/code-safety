# Hardcoded Secrets Detection Rules
# Detects hardcoded credentials, API keys, and other secrets
#
# CWE-798: Use of Hard-coded Credentials
# OWASP A02:2021 - Cryptographic Failures

rules:
  # ==============================================================================
  # Django SECRET_KEY
  # ==============================================================================
  - id: hardcoded-django-secret-key
    message: >-
      Hardcoded Django SECRET_KEY detected. This key is used for cryptographic
      signing and should be kept secret. Use environment variables instead.

      Vulnerable: SECRET_KEY = 'my-secret-key-here'
      Safe: SECRET_KEY = os.environ.get('DJANGO_SECRET_KEY')
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-798"
      owasp: "A02:2021"
      category: security
      technology:
        - django
      confidence: HIGH
      likelihood: HIGH
      impact: HIGH
      references:
        - https://docs.djangoproject.com/en/4.2/ref/settings/#secret-key
    patterns:
      - pattern: SECRET_KEY = "..."
      - pattern-not: SECRET_KEY = os.environ.get(...)
      - pattern-not: SECRET_KEY = os.getenv(...)
      - pattern-not: SECRET_KEY = config(...)
      - pattern-not: SECRET_KEY = env(...)

  # ==============================================================================
  # AWS Credentials
  # ==============================================================================
  - id: hardcoded-aws-access-key
    message: >-
      Hardcoded AWS Access Key ID detected. AWS credentials should be managed
      via IAM roles, environment variables, or AWS Secrets Manager.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-798"
      owasp: "A02:2021"
      category: security
      confidence: HIGH
    patterns:
      - pattern-either:
          - pattern: AWS_ACCESS_KEY_ID = "AKIA..."
          - pattern: aws_access_key_id = "AKIA..."
          - pattern: access_key = "AKIA..."
          - pattern-regex: 'AKIA[0-9A-Z]{16}'

  - id: hardcoded-aws-secret-key
    message: >-
      Hardcoded AWS Secret Access Key detected. Use IAM roles or environment
      variables for AWS credentials.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-798"
      owasp: "A02:2021"
      category: security
      confidence: MEDIUM
    patterns:
      - pattern-either:
          - pattern: AWS_SECRET_ACCESS_KEY = "..."
          - pattern: aws_secret_access_key = "..."
          - pattern: secret_key = "..."
      - pattern-not: $VAR = os.environ.get(...)
      - pattern-not: $VAR = os.getenv(...)
      - metavariable-regex:
          metavariable: $VAR
          regex: '.*(secret|SECRET).*'

  # ==============================================================================
  # Stripe API Keys
  # ==============================================================================
  - id: hardcoded-stripe-secret-key
    message: >-
      Hardcoded Stripe secret key detected. Live Stripe keys should never be
      committed to source code. Use environment variables.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-798"
      owasp: "A02:2021"
      category: security
      confidence: HIGH
    patterns:
      - pattern-regex: 'sk_live_[0-9a-zA-Z]{24,}'

  - id: hardcoded-stripe-test-key
    message: >-
      Hardcoded Stripe test key detected. While test keys are less sensitive,
      they should still be stored securely.
    severity: WARNING
    languages: [python]
    metadata:
      cwe: "CWE-798"
      owasp: "A02:2021"
      category: security
      confidence: HIGH
    patterns:
      - pattern-regex: 'sk_test_[0-9a-zA-Z]{24,}'

  # ==============================================================================
  # Database Passwords
  # ==============================================================================
  - id: hardcoded-database-password
    message: >-
      Hardcoded database password detected. Use environment variables or
      a secrets manager for database credentials.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-798"
      owasp: "A02:2021"
      category: security
      confidence: MEDIUM
    patterns:
      - pattern-either:
          - pattern: |
              DATABASES = {
                ...,
                "PASSWORD": "...",
                ...
              }
          - pattern: |
              'PASSWORD': '...'
          - pattern: PASSWORD = "..."
      - pattern-not: PASSWORD = os.environ.get(...)
      - pattern-not: PASSWORD = os.getenv(...)
      - pattern-not: PASSWORD = ""
      - pattern-not: PASSWORD = config(...)

  # ==============================================================================
  # Generic API Keys
  # ==============================================================================
  - id: hardcoded-api-key
    message: >-
      Potential hardcoded API key detected. API keys should be stored in
      environment variables or a secrets manager.
    severity: WARNING
    languages: [python]
    metadata:
      cwe: "CWE-798"
      owasp: "A02:2021"
      category: security
      confidence: MEDIUM
    patterns:
      - pattern-either:
          - pattern: API_KEY = "..."
          - pattern: api_key = "..."
          - pattern: APIKEY = "..."
          - pattern: apikey = "..."
      - pattern-not: $VAR = os.environ.get(...)
      - pattern-not: $VAR = os.getenv(...)
      - pattern-not: $VAR = ""
      - pattern-not: $VAR = None

  # ==============================================================================
  # JWT Secrets
  # ==============================================================================
  - id: hardcoded-jwt-secret
    message: >-
      Hardcoded JWT secret detected. JWT signing keys should be stored securely
      and rotated periodically.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-798"
      owasp: "A02:2021"
      category: security
      confidence: MEDIUM
    patterns:
      - pattern-either:
          - pattern: JWT_SECRET = "..."
          - pattern: JWT_SECRET_KEY = "..."
          - pattern: jwt_secret = "..."
      - pattern-not: $VAR = os.environ.get(...)
      - pattern-not: $VAR = os.getenv(...)

  # ==============================================================================
  # Private Keys
  # ==============================================================================
  - id: hardcoded-private-key
    message: >-
      Hardcoded private key detected. Private keys should never be committed
      to source code. Use secure key management.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-798"
      owasp: "A02:2021"
      category: security
      confidence: HIGH
    patterns:
      - pattern-regex: '-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----'

  # ==============================================================================
  # GitHub Tokens
  # ==============================================================================
  - id: hardcoded-github-token
    message: >-
      Hardcoded GitHub token detected. GitHub tokens provide access to
      repositories and should be kept secret.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-798"
      owasp: "A02:2021"
      category: security
      confidence: HIGH
    patterns:
      - pattern-regex: 'gh[pousr]_[A-Za-z0-9_]{36,}'

  # ==============================================================================
  # Slack Tokens
  # ==============================================================================
  - id: hardcoded-slack-token
    message: >-
      Hardcoded Slack token detected. Slack tokens can be used to access
      workspace data and should be stored securely.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-798"
      owasp: "A02:2021"
      category: security
      confidence: HIGH
    patterns:
      - pattern-regex: 'xox[baprs]-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24}'

  # ==============================================================================
  # SendGrid API Key
  # ==============================================================================
  - id: hardcoded-sendgrid-key
    message: >-
      Hardcoded SendGrid API key detected. Email service credentials should
      be stored in environment variables.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-798"
      owasp: "A02:2021"
      category: security
      confidence: HIGH
    patterns:
      - pattern-regex: 'SG\.[a-zA-Z0-9_-]{22}\.[a-zA-Z0-9_-]{43}'
