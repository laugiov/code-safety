# Command Injection Detection Rules for Semgrep
# Detects OS command injection patterns in Python applications
#
# CWE-78: Improper Neutralization of Special Elements used in an OS Command
# OWASP A03:2021 - Injection

rules:
  # ==============================================================================
  # os.system() Command Injection
  # ==============================================================================
  - id: command-injection-os-system
    message: >-
      Command Injection vulnerability: User input flows to os.system().
      This allows arbitrary command execution. Use subprocess with shell=False
      and a list of arguments instead.

      Vulnerable: os.system(f"ping {user_input}")
      Safe: subprocess.run(["ping", user_input], shell=False)
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-78"
      owasp: "A03:2021"
      category: security
      technology:
        - python
      confidence: HIGH
      likelihood: HIGH
      impact: CRITICAL
      references:
        - https://owasp.org/www-community/attacks/Command_Injection
        - https://docs.python.org/3/library/subprocess.html
    patterns:
      - pattern-either:
          - pattern: |
              os.system(f"...{$USER_INPUT}...")
          - pattern: |
              os.system("..." + $USER_INPUT + "...")
          - pattern: |
              os.system("..." + $USER_INPUT)
          - pattern: |
              os.system($USER_INPUT + "...")
          - pattern: |
              $CMD = f"...{$USER_INPUT}..."
              ...
              os.system($CMD)
          - pattern: |
              $CMD = "..." + $USER_INPUT + "..."
              ...
              os.system($CMD)

  # ==============================================================================
  # os.popen() Command Injection
  # ==============================================================================
  - id: command-injection-os-popen
    message: >-
      Command Injection via os.popen(). User input in command string allows
      arbitrary command execution. Use subprocess with shell=False instead.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-78"
      owasp: "A03:2021"
      category: security
      confidence: HIGH
    patterns:
      - pattern-either:
          - pattern: os.popen(f"...{$USER_INPUT}...")
          - pattern: os.popen("..." + $USER_INPUT + "...")
          - pattern: os.popen("..." + $USER_INPUT)
          - pattern: |
              $CMD = f"...{$USER_INPUT}..."
              ...
              os.popen($CMD)

  # ==============================================================================
  # subprocess with shell=True
  # ==============================================================================
  - id: command-injection-subprocess-shell
    message: >-
      Command Injection: User input passed to subprocess with shell=True.
      When shell=True, the command is executed through the shell, allowing
      shell metacharacters to be interpreted.

      Vulnerable: subprocess.call(f"cmd {user_input}", shell=True)
      Safe: subprocess.call(["cmd", user_input], shell=False)
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-78"
      owasp: "A03:2021"
      category: security
      confidence: HIGH
    patterns:
      - pattern-either:
          # subprocess.call with shell=True
          - pattern: subprocess.call(f"...{$USER_INPUT}...", shell=True, ...)
          - pattern: subprocess.call("..." + $USER_INPUT + "...", shell=True, ...)
          - pattern: subprocess.call($CMD, shell=True, ...)
          # subprocess.run with shell=True
          - pattern: subprocess.run(f"...{$USER_INPUT}...", shell=True, ...)
          - pattern: subprocess.run("..." + $USER_INPUT + "...", shell=True, ...)
          - pattern: subprocess.run($CMD, shell=True, ...)
          # subprocess.Popen with shell=True
          - pattern: subprocess.Popen(f"...{$USER_INPUT}...", shell=True, ...)
          - pattern: subprocess.Popen("..." + $USER_INPUT + "...", shell=True, ...)
          - pattern: subprocess.Popen($CMD, shell=True, ...)
          # subprocess.check_output with shell=True
          - pattern: subprocess.check_output(f"...{$USER_INPUT}...", shell=True, ...)
          - pattern: subprocess.check_output("..." + $USER_INPUT + "...", shell=True, ...)
          - pattern: subprocess.check_output($CMD, shell=True, ...)
          # subprocess.check_call with shell=True
          - pattern: subprocess.check_call(f"...{$USER_INPUT}...", shell=True, ...)
          - pattern: subprocess.check_call("..." + $USER_INPUT + "...", shell=True, ...)

  # ==============================================================================
  # Request Data to Command (Full Taint Flow)
  # ==============================================================================
  - id: django-request-to-command-injection
    message: >-
      Command Injection: HTTP request data flows to command execution.
      Sanitize input or use subprocess with shell=False and argument lists.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-78"
      owasp: "A03:2021"
      category: security
      confidence: HIGH
    mode: taint
    pattern-sources:
      - pattern: request.GET.get(...)
      - pattern: request.POST.get(...)
      - pattern: request.GET[...]
      - pattern: request.POST[...]
      - pattern: request.data.get(...)
      - pattern: request.data[...]
    pattern-sinks:
      - pattern: os.system($CMD)
        focus-metavariable: $CMD
      - pattern: os.popen($CMD, ...)
        focus-metavariable: $CMD
      - pattern: subprocess.call($CMD, shell=True, ...)
        focus-metavariable: $CMD
      - pattern: subprocess.run($CMD, shell=True, ...)
        focus-metavariable: $CMD
      - pattern: subprocess.Popen($CMD, shell=True, ...)
        focus-metavariable: $CMD
      - pattern: subprocess.check_output($CMD, shell=True, ...)
        focus-metavariable: $CMD
    pattern-sanitizers:
      - pattern: shlex.quote(...)
      - pattern: pipes.quote(...)

  # ==============================================================================
  # eval() / exec() with User Input
  # ==============================================================================
  - id: code-injection-eval-exec
    message: >-
      Code Injection: User input passed to eval() or exec(). This allows
      arbitrary Python code execution. Never use eval/exec with untrusted input.
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-94"
      owasp: "A03:2021"
      category: security
      confidence: HIGH
      impact: CRITICAL
    patterns:
      - pattern-either:
          - pattern: eval($USER_INPUT)
          - pattern: eval(f"...{$USER_INPUT}...")
          - pattern: exec($USER_INPUT)
          - pattern: exec(f"...{$USER_INPUT}...")
          - pattern: compile($USER_INPUT, ...)
